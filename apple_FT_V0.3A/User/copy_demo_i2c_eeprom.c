/*
*********************************************************************************************************
*
*	???? : EEPROM???????
*	???? : eeDemo.c
*	?    ? : V1.1
*	?    ? : EERPOM ?24xx??????????STM32-F4??????EEPROM??? AT24C128  (16K??,128Kbit)
*
*	???? :
*		???  ??        ??     ??
*		V1.0    2013-02-01 plxc  ????
*		V1.1    2013-06-20 plxc  ??????????????? getchar() ?????
*
*	Copyright (C), 2023-2024, ???? www.spacetouch.co
*
*********************************************************************************************************
*/

#include "bsp.h"

/* ?????????????? */
static void ee_DispMenu(void);
static void ee_ReadTest(void);
static void ee_WriteTest(void);
static void ee_Erase(void);

uint8_t buf[EE_SIZE];	/* ???????? 16KB */

/*
*********************************************************************************************************
*	? ? ?: DemoEEPROM
*	????: ??EEPROM????
*	?    ???
*	? ? ?: ?
*********************************************************************************************************
*/
void DemoEEPROM(void)
{
	uint8_t cmd;

	if (ee_CheckOk() == 0)
	{
		/* ?????EEPROM */
		printf("???????EEPROM!\r\n");

		while (1);	/* ?? */
	}

	printf("???????EEPROM : \r\n");
	printf("??: %s, ?? = %d ??, ???? = %d\r\n", EE_MODEL_NAME, EE_SIZE, EE_PAGE_SIZE);

	ee_DispMenu();		/* ?????? */
	while(1)
	{
		bsp_Idle();		/* ?????bsp.c???????????????CPU????? */
		
		//cmd = getchar();	/* ????????? (????) */
		if (comGetChar(COM1, &cmd))	/* ?????????(?????) */
		{
			switch (cmd)
			{
				case '1':
					printf("\r\n?1 - ? EEPROM ???\r\n");
					ee_ReadTest();		/* ?EEPROM???????????? */
					break;

				case '2':
					printf("\r\n?2 - ? EEPROM ???\r\n");
					ee_WriteTest();		/* ?EEPROM?????????? */
					break;

				case '3':
					printf("\r\n?3 - ?? EEPROM?\r\n");
					ee_Erase();			/* ??EEPROM???????????0xFF */
					break;

				default:
					ee_DispMenu();	/* ????????????? */
					break;

			}
		}
	}
}

/*
*********************************************************************************************************
*	? ? ?: ee_ReadTest
*	????: ???EEPROM??????????
*	?    ???
*	? ? ?: ?
*********************************************************************************************************
*/
static void ee_ReadTest(void)
{
	uint16_t i;
	int32_t iTime1, iTime2;

	/* ?EEPROM, ???? = 0? ????? 256 */
	iTime1 = bsp_GetRunTime();	/* ?????? */
	if (ee_ReadBytes((uint8_t *)buf, 0, EE_SIZE) == 0)
	{
		printf("?eeprom???\r\n");
		return;
	}
	else
	{
		iTime2 = bsp_GetRunTime();	/* ?????? */
		printf("?eeprom????????\r\n");
	}

	/* ???? */
	for (i = 0; i < EE_SIZE; i++)
	{
		printf(" %02X", buf[i]);

		if ((i & 31) == 31)
		{
			printf("\r\n");	/* ????16???? */
		}
		else if ((i & 31) == 15)
		{
			printf(" - ");
		}
	}

	/* ????? */
	printf("???: %dms, ???: %dB/s\r\n", iTime2 - iTime1, (EE_SIZE * 1000) / (iTime2 - iTime1));
}

/*
*********************************************************************************************************
*	? ? ?: ee_ReadTest
*	????: ???EEPROM????
*	?    ???
*	? ? ?: ?
*********************************************************************************************************
*/
static void ee_WriteTest(void)
{
	uint16_t i;
	int32_t iTime1, iTime2;

	/* ??????? */
	for (i = 0; i < EE_SIZE; i++)
	{
		buf[i] = i;
	}

	/* ?EEPROM, ???? = 0?????? 256 */
	iTime1 = bsp_GetRunTime();	/* ?????? */
	if (ee_WriteBytes(buf, 0, EE_SIZE) == 0)
	{
		printf("?eeprom???\r\n");
		return;
	}
	else
	{
		iTime2 = bsp_GetRunTime();	/* ?????? */
		printf("?eeprom???\r\n");
	}


	/* ????? */
	printf("???: %dms, ???: %dB/s\r\n", iTime2 - iTime1, (EE_SIZE * 1000) / (iTime2 - iTime1));
}

/*
*********************************************************************************************************
*	? ? ?: ee_ReadTest
*	????: ???EEPROM??????????
*	?    ???
*	? ? ?: ?
*********************************************************************************************************
*/
static void ee_Erase(void)
{
	uint16_t i;

	/* ????? */
	for (i = 0; i < EE_SIZE; i++)
	{
		buf[i] = 0xFF;
	}

	/* ?EEPROM, ???? = 0?????? 256 */
	if (ee_WriteBytes(buf, 0, EE_SIZE) == 0)
	{
		printf("??eeprom???\r\n");
		return;
	}
	else
	{
		printf("??eeprom???\r\n");
	}
}

/*
*********************************************************************************************************
*	? ? ?: ee_DispMenu
*	????: ????????
*	?    ???
*	? ? ?: ?
*********************************************************************************************************
*/
static void ee_DispMenu(void)
{
	printf("\r\n------------------------------------------------\r\n");
	printf("???????:\r\n");
	printf("1 - ?EEPROM (%d ??)\r\n", EE_SIZE);
	printf("2 - ?EEPROM (%d ??,0x00-0xFF)\r\n", EE_SIZE);
	printf("3 - ??EEPROM\r\n");
	printf("4 - ??????\r\n");
}

/***************************** ???? www.spacetouch.co (END OF FILE) *********************************/
